name: ðŸ­ FE-Factory CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # â”€â”€â”€ é˜¶æ®µ 1: è´¨é‡å®ˆå« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality-gate:
    name: ðŸ” è´¨é‡å®ˆå« (Lint + TypeCheck + Build)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”§ é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ðŸ” ESLint æ£€æŸ¥
        run: npm run lint -- --max-warnings=0

      - name: ðŸ“ Prettier æ ¼å¼æ£€æŸ¥
        run: npx prettier --check "src/**/*.{ts,vue,less}"

      - name: ðŸ·ï¸ TypeScript ç±»åž‹æ£€æŸ¥
        run: npm run build -- --noEmit || npx vue-tsc --noEmit

      - name: ðŸ—ï¸ æž„å»ºéªŒè¯
        run: npm run build

      - name: ðŸ“Š æž„å»ºäº§ç‰©å¤§å°åˆ†æž
        run: |
          echo "=== æž„å»ºäº§ç‰©å¤§å° ===" >> $GITHUB_STEP_SUMMARY
          du -sh dist/ >> $GITHUB_STEP_SUMMARY
          ls -la dist/assets/ | head -20 >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€ é˜¶æ®µ 2: å•å…ƒæµ‹è¯• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  unit-tests:
    name: ðŸ§ª å•å…ƒæµ‹è¯• (Vitest)
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'npm' }
      - run: npm ci
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: npx vitest run --coverage
      - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # â”€â”€â”€ é˜¶æ®µ 3: E2E æµ‹è¯• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  e2e-tests:
    name: ðŸŽ­ E2E æµ‹è¯• (Playwright)
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'npm' }
      - run: npm ci

      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: npx playwright install --with-deps chromium

      - name: æž„å»º & å¯åŠ¨é¢„è§ˆæœåŠ¡
        run: |
          npm run build
          npx serve -s dist -l 4173 &
          sleep 3

      - name: è¿è¡Œ E2E æµ‹è¯•
        run: npx playwright test
        env:
          BASE_URL: http://localhost:4173

      - name: ä¸Šä¼  Playwright æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: tests/playwright-report/
          retention-days: 7

  # â”€â”€â”€ é˜¶æ®µ 4: è§†è§‰å›žå½’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  visual-regression:
    name: ðŸ‘ï¸ è§†è§‰å›žå½’æµ‹è¯•
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'npm' }
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - name: å¯åŠ¨é¢„è§ˆæœåŠ¡
        run: npm run build && npx serve -s dist -l 4173 &
      - name: è§†è§‰å¿«ç…§å¯¹æ¯”
        run: npx playwright test --grep @visual
        continue-on-error: true

  # â”€â”€â”€ é˜¶æ®µ 5: æ€§èƒ½åŸºå‡† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lighthouse:
    name: âš¡ æ€§èƒ½åŸºå‡† (Lighthouse CI)
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'npm' }
      - run: npm ci && npm run build
      - name: è¿è¡Œ Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # â”€â”€â”€ é˜¶æ®µ 6: éƒ¨ç½²ï¼ˆä»… main åˆ†æ”¯ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ðŸš€ ç”Ÿäº§éƒ¨ç½²
    needs: [unit-tests, e2e-tests, lighthouse]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '${{ env.NODE_VERSION }}', cache: 'npm' }
      - run: npm ci && npm run build

      - name: æ³¨å…¥ç‰ˆæœ¬å·
        run: echo "VITE_RELEASE_VERSION=${{ github.sha }}" >> .env.production

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "dist/"
          target: "/var/www/html/${{ github.event.repository.name }}"

      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        run: |
          echo "## âœ… éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- ç‰ˆæœ¬: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- è§¦å‘è€…: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
